#!/usr/bin/env ruby

# frozen_string_literal: true

require 'on_container/dev/rails'

set_given_or_default_command

if command_requires_setup?
  on_setup_lock_acquired do
    ensure_project_gems_are_installed

    setup_activerecord_database if command_might_require_database? && !activerecord_database_ready?

    system 'rails db:test:prepare' if %w[rspec].include?(ARGV[0])

    remove_rails_pidfile if rails_server?
  end
end

execute_given_or_default_command
