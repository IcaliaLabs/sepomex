name: CI & CD

on:
  # Trigger the workflow on pushes to the main branch, including PR merges:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write
  deployments: write

env:
  PROJECT_ID: sepomex-365521
  IMAGE_NAME: sepomex
  GAR_LOCATION: us-central1
  REPOSITORY: icalialabs-sepomex
  SERVICE: sepomex
  REGION: us-central1

jobs:
  build-and-push-to-gcp:
    name: Build and Push to GCP
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v0
      with:
        token_format: access_token
        workload_identity_provider: projects/582875546495/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: github-actions@sepomex-365521.iam.gserviceaccount.com

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.6.0

    - name: Docker Auth
      id: docker-auth
      uses: docker/login-action@v1
      with:
        username: oauth2accesstoken
        password: ${{ steps.auth.outputs.access_token }}
        registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Build and Push Container
      run: |-
        docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }} ./
        docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }}

    - name: Deploy to Cloud Run
      id: deploy
      run: |-
        gcloud config set project ${{ env.PROJECT_ID }}
        gcloud run deploy ${{ env.SERVICE }} --image ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }} --q --region ${{ env.REGION }} --port 3000 --allow-unauthenticated
